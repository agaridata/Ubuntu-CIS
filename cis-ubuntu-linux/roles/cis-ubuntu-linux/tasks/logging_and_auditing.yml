---

- name: "4.1.17 Ensure kernel module loading and unloading is collected (Scored)" 
  apt:
      name: auditd
      state: present
  tags:
    - section_4
    - scored

- name: "4.1.17 Ensure kernel module loading and unloading is collected (Scored)"
  lineinfile:
    path: /etc/audit/audit.rules
    line: '{{ item }}'
    state: present
    create: yes
  with_items:
    - '-w /sbin/insmod -p x -k modules'
    - '-w /sbin/rmmod -p x -k modules'
    - '-w /sbin/modprobe -p x -k modules'
    - '-a always,exit -F arch=b64 -S init_module -S delete_module -k modules'
  notify: restart auditd
  tags:
    - section_4
    - scored

- name: "4.2.1.1 Ensure rsyslog Service is enabled (Scored)"
  apt:
    name: "{{ syslog_package }}"
    state: present
  tags:
    - section_4
    - scored

- name: "4.2.1.1 Ensure rsyslog Service is enabled (Scored)"
  command: dpkg-query -s "{{ syslog_package }}"
  register: syslog_package
  changed_when: False
  failed_when: False
  check_mode: no
  tags:
    - section_4
    - scored

- name: "4.2.1.1 Ensure rsyslog Service is enabled (Scored)"
  service:
    name: rsyslog
    state: started
    enabled: yes
  when: syslog_package.rc == 0
  tags:
    - section_4
    - scored

- name: "4.2.1.2 Ensure logging is configured (Not Scored)" 
  lineinfile:
      path: /etc/rsyslog.conf
      line: '{{ item }}'
      insertafter: EOF
  with_items:
    - '*.emerg :omusrmsg:*'
    - 'mail.* -/var/log/mail'
    - 'mail.info -/var/log/mail.info'
    - 'mail.warning -/var/log/mail.warn'
    - 'mail.err /var/log/mail.err'
    - 'news.crit -/var/log/news/news.crit'
    - 'news.err -/var/log/news/news.err'
    - 'news.notice -/var/log/news/news.notice'
    - '*.=warning;*.=err -/var/log/warn'
    - '*.crit /var/log/warn'
    - '*.*;mail.none;news.none -/var/log/messages'
    - 'local0,local1.* -/var/log/localmessages'
    - 'local2,local3.* -/var/log/localmessages'
    - 'local4,local5.* -/var/log/localmessages'
    - 'local6,local7.* -/var/log/localmessages'
  notify: restart rsyslog
  when: syslog_package.rc == 0
  tags:
    - section_4
    - not_scored

- name: "4.2.2.2 Ensure logging is configured (Not Scored)"
  copy:
    src: '{{ item }}'
    dest: /etc/logrotate.d/
    mode: 0644
  with_items:
    - iptables
    - mail
    - mail.info
    - mail.warn
    - mail.err
    - news.crit
    - news.err
    - news.notice
    - warn
    - localmessages
  when: syslog_package.rc == 0
  tags:
    - section_4
    - not_scored

- name: "4.2.2.2 Ensure logging is configured (Not Scored)"
  file:
    path: /var/log/{{ item }}
    state: touch
    owner: root
    group: adm
    mode: 0640
  with_items:
    - iptables
    - mail
    - mail.info
    - mail.warn
    - mail.err
    - news.crit
    - news.err
    - news.notice
    - warn
    - localmessages    
  when: syslog_package.rc == 0
  tags:
    - section_4
    - not_scored

- name: "4.2.1.4 Ensure rsyslog is configured to send logs to a remote log host (Scored)"
  command: grep "^*.*[^I][^I]*@" /etc/rsyslog.conf
  register: remoteloghost
  changed_when: False
  failed_when: False
  check_mode: no
  tags:
    - section_4
    - scored

- name: "4.2.1.4 Ensure rsyslog is configured to send logs to a remote log host (Scored)"
  lineinfile:
    path: /etc/rsyslog.conf
    line: '*.* @@{{ remote_logs_host_address }}'
    insertafter: EOF
    state: present
  notify: restart rsyslog
  when: remoteloghost.rc == 1 and syslog_package.rc == 0
  tags:
    - section_4
    - scored

- name: "4.2.1.5 Ensure remote rsyslog messages are only accepted on designated log hosts. (Not Scored)"
  command: grep '^$ModLoad imtcp' /etc/rsyslog.conf
  register: moadloadpresent
  failed_when: False
  check_mode: no
  tags:
    - section_4
    - not_scored

- name: "4.2.1.5 Ensure remote rsyslog messages are only accepted on designated log hosts. (Not Scored)"
  lineinfile:
    path: /etc/rsyslog.conf
    regexp: '^#({{ item }})'
    line: '{{ item }}'
    state: present
  with_items:
      - '$ModLoad imtcp'
      - '$InputTCPServerRun 514'
  notify: restart rsyslog
  when: moadloadpresent.rc == 0 and syslog_package.rc == 0
  tags:
    - section_4
    - not_scored

- name: "4.2.2.1 Ensure syslog-ng service is enabled (Scored)" 
  command: dpkg-query -s syslog-ng
  register: syslogng_package
  changed_when: False
  failed_when: False
  check_mode: no
  tags:
    - section_4
    - scored

- name: "4.2.2.1 Ensure syslog-ng service is enabled (Scored)" 
  service:
    name: syslog-ng
    enabled: yes
  when: syslogng_package.rc == 0
  tags:
    - section_4
    - scored

- name: "4.2.2.2 Ensure logging is configured (Not Scored)"
  lineinfile:
      path: /etc/syslog-ng/syslog-ng.conf
      line: '{{ item }}'
      insertafter: '^# message go where.'
  with_items:
    - 'filter f_iptables { facility(kern) and match("IN=") and match("OUT="); };'
    - 'filter f_acpid { match("^\[acpid\]:"); };'
    - 'filter f_acpid_old  { match("^\[acpid\]:"); };'
    - 'filter f_acpid_full { match("^\acpid:"); };'
    - 'filter f_netmgm { match("^NetworkManager:"); };'
  when: syslogng_package.rc == 0
  notify: restart syslog-ng
  tags:
    - section_4
    - not_scored

- name: "4.2.2.2 Ensure logging is configured (Not Scored)"
  lineinfile:
      path: /etc/syslog-ng/syslog-ng.conf
      line: '{{ item }}'
      insertbefore: '^# This files are the log come from the mail subsystem.'
  with_items:
    - 'destination d_firewall { file("/var/log/iptables"); };'
    - 'destination d_acpid { file("/var/log/acpid"); };'
    - 'destination d_netmgm { file("/var/log/NetworkManager"); };'
    - 'destination d_locmessages { file("/var/log/localmessages"); };'
    - 'destination d_warn { file("/var/log/warn" fsync(yes)); };'
    - 'destination d_devnull { };'
  when: syslogng_package.rc == 0 
  notify: restart syslog-ng
  tags:
    - section_4
    - not_scored

- name: "4.2.2.2 Ensure logging is configured (Not Scored)"
  lineinfile:
      path: /etc/syslog-ng/syslog-ng.conf
      line: '{{ item }}'
      insertbefore: '^# All messages send to a remote site'
  with_items:
    - 'log { source(s_src); filter(f_mail); filter (f_info); destination(d_mailinfo); };'
    - 'log { source(s_src); filter(f_mail); filter (f_warn); destination(d_mailwarn); };'
    - 'log { source(s_src); filter(f_mail); filter (f_err); destination(d_mailerr); };'
    - 'log { source(s_src); filter(f_mail); destination(d_mail); };'
    - 'log { source(s_src); filter(f_acpid); destination(d_acpid); flags(final); };'
    - 'log { source(s_src); filter(f_acpid_full); destination(d_devnull); flags(final); };'
    - 'log { source(s_src); filter(f_acpid_old); destination(d_acpid); flags(final); };'
    - 'log { source(s_src); filter(f_netmgm); destination(d_netmgm); flags(final); };'
    - 'log { source(s_src); filter(f_local); destination(d_locmessages); };'
    - 'log { source(s_src); filter(f_iptables); destination(d_firewall); };'
    - 'log { source(s_src); filter(f_warn); destination(d_warn); };'
  changed_when: False
  when: syslogng_package.rc == 0 
  notify: restart syslog-ng
  tags:
    - section_4
    - not_scored

- name: "4.2.2.2 Ensure logging is configured (Not Scored)"
  lineinfile:
     name: "{{ iptables_rules_file }}"
     line: "{{ item }}"
     insertbefore: '^COMMIT'
  with_items:
     - '-A INPUT -m state --state INVALID -j LOG --log-prefix "Iptables: Invalid packet: "'
     - '-A INPUT -m limit --limit 3/minute --limit-burst 3 -j LOG --log-prefix "Iptables: INPUT packet died: "'
     - '-A FORWARD -m limit --limit 3/minute --limit-burst 3 -j LOG --log-prefix "Iptables: FORWARD packet died: "'
  when: syslogng_package.rc == 0
  notify: restart iptables
  tags:
    - section_4
    - not_scored

- name: "4.2.2.2 Ensure logging is configured (Not Scored)"
  copy:
    src: '{{ item }}'
    dest: /etc/logrotate.d/
    mode: 0644
  with_items:
    - iptables
    - NetworkManager
    - acpid
    - warn
    - localmessages
  when: syslogng_package.rc == 0
  tags:
    - section_4
    - not_scored

- name: "4.2.2.2 Ensure logging is configured (Not Scored)"
  file:
    path: /var/log/{{ item }}
    state: touch
    owner: root
    group: adm
    mode: 0640
  with_items:
    - iptables
    - NetworkManager
    - acpid
    - warn
    - localmessages    
  when: syslogng_package.rc == 0
  tags:
    - section_4
    - not_scored

- name: "4.2.2.3 Ensure syslog-ng default file permissions configured (Scored)"
  command: sed -i '/\t  owner("root"); group("adm"); perm(0640); stats_freq(0);\|\t  bad_hostname("^gconfd$");/d' /etc/syslog-ng/syslog-ng.conf
  when: syslogng_package.rc == 0
  notify: restart syslog-ng
  tags:
    - section_4
    - scored

- name: "4.2.2.3 Ensure syslog-ng default file permissions configured (Scored)"
  lineinfile:
    path: /etc/syslog-ng/syslog-ng.conf
    regexp: '^options'
    line: 'options { chain_hostnames(off); flush_lines(0); use_dns(no); use_fqdn(no); owner("root"); group("adm"); perm(0640); stats_freq(0); bad_hostname("^gconfd$");'
  when: syslogng_package.rc == 0 
  notify: restart syslog-ng
  tags:
    - section_4
    - scored

- name: "4.2.2.4 Ensure syslog-ng is configured to send logs to a remote log host (Not Scored)" 
  lineinfile:
    path: /etc/syslog-ng/syslog-ng.conf
    regexp: '^destination logserver'
    insertafter: '^#destination d_net'
    line: 'destination logserver { tcp("{{ remote_logs_host_address }}" port(514)); }; log { source(s_src); destination(logserver); };'
  when: syslogng_package.rc == 0 
  notify: restart syslog-ng
  tags:
    - section_4
    - not_scored

- name: "4.2.2.5 Ensure remote syslog-ng messages are only accepted on designated log hosts (Not Scored)"
  lineinfile:
    path: /etc/syslog-ng/syslog-ng.conf
    line: '{{ item }}'
    insertafter: EOF
  with_items:
    - 'source net{ tcp(); };'
    - 'destination remote { file("/var/log/remote/${FULLHOST}-log"); };'
    - 'log { source(net); destination(remote); };'
  when: syslogng_package.rc == 0 
  notify: restart syslog-ng
  tags:
    - section_4
    - not_scored
